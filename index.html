<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>I $TRUST MY INTUITION ‚Äî SBT Mint (TRUST Testnet)</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    :root{--bg:#0b0d12;--card:#12151d;--accent:#4ade80;--muted:#9aa4b2;--text:#f1f5f9}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;display:grid;place-items:center;min-height:100vh}
    .card{width:min(720px,92vw);background:var(--card);border-radius:22px;padding:28px;box-shadow:0 8px 30px #0008}
    h1{margin:0 0 8px;font-size:clamp(20px,4vw,30px);letter-spacing:.2px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    button{appearance:none;border:0;border-radius:14px;padding:12px 16px;background:var(--accent);color:#05240f;font-weight:700;cursor:pointer;transition:.2s;font-size:14px}
    button.secondary{background:#1b2333;color:#dbe3f0;border:1px solid #2b3750}
    button:disabled{opacity:.55;cursor:not-allowed}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .status{margin-top:14px;color:var(--muted);min-height:24px;white-space:pre-wrap}
    img#sbtPreview{width:300px;height:300px;border-radius:14px;margin-top:16px;border:1px solid #1c2232;}
  </style>
</head>
<body>
  <main class="card">
    <h1>Soulbound Token Mint</h1>
    <div class="row">
      <button id="connectWallet">Connect Wallet</button>
      <button id="mintSBT" class="secondary" disabled>Mint SBT</button>
    </div>
    <div class="status" id="status">Not connected</div>
    <div class="row">
      <div>Connected: <span id="walletAddress" class="mono">‚Äî</span></div>
      <div>Network: <span id="netStatus" class="mono">‚Äî</span></div>
    </div>
    <img id="sbtPreview" alt="SBT Preview"/>
  </main>

  <script>
    const CONTRACT_ADDRESS = "0x04F805Ea014c7c28101CA62d2c7f83fC480ddaba";
    const TRUST_CHAIN_ID_HEX = "0x350B"; // 13579 decimal
    const TRUST_PARAMS = {
      chainId: TRUST_CHAIN_ID_HEX,
      chainName: "TRUST Testnet",
      nativeCurrency: { name: "TRUST", symbol: "TST", decimals: 18 },
      rpcUrls: ["https://testnet.rpc.intuition.systems/http"],
      blockExplorerUrls: ["https://testnet.hub.intuition.systems/"]
    };
    const CONTRACT_ABI = [
      "function mint()",
      "function mint(address to)",
      "function safeMint(address to)",
      "function safeMint(address to,uint256 tokenId)",
      "function balanceOf(address owner) view returns (uint256)"
    ];

    const $ = s => document.querySelector(s);
    const connectBtn = $("#connectWallet");
    const mintBtn = $("#mintSBT");
    const addrEl = $("#walletAddress");
    const netEl = $("#netStatus");
    const statusEl = $("#status");
    const sbtImg = $("#sbtPreview");

    let provider, signer, userAddress, contract;

    function setStatus(msg){ statusEl.textContent = msg || ""; }

    function generateSBTImage(address){
      const canvas = document.createElement("canvas");
      canvas.width = 300; canvas.height = 300;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle="#121212"; ctx.fillRect(0,0,300,300);
      ctx.beginPath(); ctx.arc(150,150,100,0,2*Math.PI); ctx.fillStyle="#4ade80"; ctx.fill();
      ctx.fillStyle="#fff"; ctx.font="16px Arial"; ctx.textAlign="center";
      ctx.fillText("SBT",150,150); ctx.font="12px Arial";
      ctx.fillText(address.slice(0,6)+"..."+address.slice(-4),150,180);
      return canvas.toDataURL("image/png");
    }

    async function ensureTrustNetwork(){
      const { ethereum } = window;
      const chainId = await ethereum.request({ method:"eth_chainId" });
      if(chainId===TRUST_CHAIN_ID_HEX) return;
      try{
        await ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:TRUST_CHAIN_ID_HEX}] });
      }catch(e){
        if(e.code===4902) await ethereum.request({ method:"wallet_addEthereumChain", params:[TRUST_PARAMS] });
        else throw e;
      }
    }

    async function connect(){
      try{
        if(!window.ethereum) throw new Error("MetaMask not found");

        setStatus("Requesting wallet connection...");
        // üîë Request accounts first to trigger MetaMask popup
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        userAddress = accounts[0];
        addrEl.textContent = userAddress;

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        await ensureTrustNetwork();
        const chainId = await window.ethereum.request({ method:"eth_chainId" });
        netEl.textContent = chainId+" (expecting 0x350B)";

        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        mintBtn.disabled = false;
        sbtImg.src = generateSBTImage(userAddress);

        setStatus("‚úÖ Wallet connected. Ready to mint.");
      }catch(err){
        console.error(err);
        setStatus("‚ùå Connection failed: "+(err.message||err));
      }
    }

    async function pickMintMethod(){
      const tokenId = BigInt(Date.now());
      const candidates = [
        { fn:"mint", args:[] },
        { fn:"mint", args:[userAddress] },
        { fn:"safeMint", args:[userAddress] },
        { fn:"safeMint", args:[userAddress, tokenId] }
      ];
      for(const c of candidates){
        if(typeof contract[c.fn]?.staticCall==="function"){
          try{ await contract[c.fn].staticCall(...c.args); return c; }catch{}
        }
      }
      return { fn:"mint", args:[] }; // fallback
    }

    async function mint(){
      if(!signer) return setStatus("Connect your wallet first.");
      try{
        setStatus("Preparing mint...");
        const chosen = await pickMintMethod();
        setStatus(`Minting via ${chosen.fn}(${chosen.args.map(a=>typeof a==="bigint"?a.toString():a).join(", ")})...`);

        const tx = await contract[chosen.fn](...chosen.args);
        setStatus("Transaction sent: "+tx.hash+"\nWaiting for confirmation...");
        const rec = await tx.wait();
        setStatus("‚úÖ Minted in block "+rec.blockNumber);
      }catch(err){
        console.error(err);
        setStatus("‚ùå Mint failed: "+(err.message||String(err)));
      }
    }

    connectBtn.addEventListener("click",connect);
    mintBtn.addEventListener("click",mint);
  </script>
</body>
</html>
